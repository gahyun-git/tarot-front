"use client";
import { createContext, PropsWithChildren, useCallback, useContext, useEffect, useMemo, useState } from "react";

export type Locale = "ko" | "en" | "ja" | "zh";

type Messages = Record<string, string>;

const dict: Record<Locale, Messages> = {
  ko: {
    "hero.heading1": "오늘의",
    "hero.heading2": "타로카드",
    "hero.tagline": "레트로 감성의 타로 리딩 UI",
    "form.title": "Tarot Reading",
    "form.question": "질문",
    "form.placeholder.question": "어떤 사람들이 내 인생에 들어올까요?",
    "form.lang": "언어",
    "form.groupOrder": "카드를 어떤 순서로 섞을까요?",
    "form.reversed": "역방향 포함",
    "form.draw8": "카드 8장 뽑기",
    "form.loading": "불러오는 중...",
    "form.validation.questionRequired": "질문을 입력해 주세요.",
    "form.help.groupOrder": "세 뭉치(A/B/C)를 어떤 순서로 뽑을지 선택합니다. 기본: A→B→C",
    "form.help.reversed": "체크하면 카드가 뒤집힌 상태(역방향)로 나올 수 있어요.",
    "picker.hint": "카드 뭉치 현재/미래/과거 중에서 클릭한 순서대로 위에 얹어 셔플합니다.",
    "picker.currentOrder": "현재 순서",
    "picker.default": "기본값",
    "picker.reverse": "역순",
    "picker.dropHint": "여기에 섞고싶은 순서로 카드를 올려주세요",
    "picker.reset": "초기화",
    "role.past": "과거",
    "role.present": "현재",
    "role.future": "미래",
    "group.A.role": "과거",
    "group.B.role": "현재",
    "group.C.role": "미래",
    "group.A.label": "과거",
    "group.B.label": "현재",
    "group.C.label": "미래",
    "picker.slot": "순서",
    "picker.num": "번째",
    "history.title": "History",
    "history.clearAll": "전체 삭제",
    "history.delete": "삭제",
    "result.title": "결과",
    "share.copy": "공유 링크 복사",
      "share.copied": "공유 링크가 복사되었습니다.",
    "daily.button": "오늘의 카드",
    "loading.meaning": "의미 불러오는 중...",
    "loading.title": "전체 해설 생성 중",
    "loading.checkCache": "캐시 확인 중...",
    "loading.request": "해설 생성 요청 중...",
    "loading.fetch": "결과 불러오는 중...",
    "loading.done": "완료!",
    "orientation.upright": "정방향",
    "orientation.reversed": "역방향",
    "badge.upright": "정",
    "badge.reversed": "역",
    "modal.cardDetail": "카드 상세 해설",
    "no.meaning": "의미 데이터가 없습니다.",
    "view.full": "전체 해설 보기",
    "spreads.title": "스프레드 선택",
    "btn.guide": "가이드",
    "btn.use": "사용",
    "nav.question": "질문",
    "nav.summary": "요약",
    "nav.positions": "포지션",
    "nav.sections": "섹션",
    "nav.advices": "조언",
    "nav.back": "뒤로",
    "label.keywords": "키워드",
    "label.solutionCard": "솔루션카드",
    "position.1": "이슈",
    "position.2": "숨은 영향",
    "position.3": "과거",
    "position.4": "현재",
    "position.5": "근미래",
    "position.6": "내면",
    "position.7": "외부",
    "position.8": "솔루션",
    "role.std.issue": "이슈",
    "role.std.hidden": "숨은 영향",
    "role.std.past": "과거",
    "role.std.present": "현재",
    "role.std.near": "근미래",
    "role.std.inner": "내면",
    "role.std.external": "외부",
    "role.std.solution": "솔루션",
  },
  en: {
    "hero.heading1": "Make your",
    "hero.heading2": "readings!",
    "hero.tagline": "tarot reading UI",
    "form.title": "Tarot Reading",
    "form.question": "Question",
    "form.placeholder.question": "What kind of people will come into my life?",
    "form.lang": "Lang",
    "form.groupOrder": "How to shuffle cards?",
    "form.reversed": "Include reversed",
    "form.draw8": "Draw 8 Cards",
    "form.loading": "Loading...",
    "form.validation.questionRequired": "Please enter a question.",
    "form.help.groupOrder": "Choose the order to draw from piles A/B/C. Default: A→B→C",
    "form.help.reversed": "If checked, a card may appear reversed.",
    "picker.hint": "Click piles (Present/Future/Past) in the order to stack-shuffle.",
    "picker.currentOrder": "Current order",
    "picker.default": "Default",
    "picker.reverse": "Reverse",
    "picker.dropHint": "Drop cards here in the order you want to shuffle",
    "picker.reset": "Reset",
    "role.past": "Past",
    "role.present": "Present",
    "role.future": "Future",
    "group.A.role": "Past",
    "group.B.role": "Present",
    "group.C.role": "Future",
    "group.A.label": "Past",
    "group.B.label": "Present",
    "group.C.label": "Future",
    "picker.slot": "Order",
    "picker.num": "",
    "history.title": "History",
    "history.clearAll": "Clear all",
    "history.delete": "Delete",
    "result.title": "Result",
    "share.copy": "Copy share link",
      "share.copied": "Share link copied.",
    "daily.button": "Daily Card",
    "loading.meaning": "Loading meaning...",
    "loading.title": "Generating full interpretation",
    "loading.checkCache": "Checking cache...",
    "loading.request": "Requesting interpretation...",
    "loading.fetch": "Fetching result...",
    "loading.done": "Done!",
    "orientation.upright": "Upright",
    "orientation.reversed": "Reversed",
    "badge.upright": "U",
    "badge.reversed": "R",
    "modal.cardDetail": "Card details",
    "no.meaning": "No meaning data.",
    "view.full": "View full interpretation",
    "spreads.title": "Choose a Spread",
    "btn.guide": "Guide",
    "btn.use": "Use",
    "nav.question": "Question",
    "nav.summary": "Summary",
    "nav.positions": "Positions",
    "nav.sections": "Sections",
    "nav.advices": "Advice",
    "nav.back": "Back",
    "label.keywords": "Keywords",
    "label.solutionCard": "Solution card",
    "position.1": "Issue",
    "position.2": "Hidden influence",
    "position.3": "Past",
    "position.4": "Present",
    "position.5": "Near future",
    "position.6": "Inner self",
    "position.7": "External",
    "position.8": "Solution",
    "role.std.issue": "Issue",
    "role.std.hidden": "Hidden Influence",
    "role.std.past": "Past",
    "role.std.present": "Present",
    "role.std.near": "Near Future",
    "role.std.inner": "Inner Self",
    "role.std.external": "External",
    "role.std.solution": "Solution",
  },
  ja: {
    "hero.heading1": "あなたの",
    "hero.heading2": "リーディング！",
    "hero.tagline": "レトロなタロットUI",
    "form.title": "タロット リーディング",
    "form.question": "質問",
    "form.placeholder.question": "どんな人たちが私の人生に入ってくる？",
    "form.lang": "言語",
    "form.groupOrder": "カードをどの順番でシャッフルするか",
    "form.reversed": "逆位置を含む",
    "form.draw8": "カードを8枚引く",
    "form.loading": "読み込み中...",
    "form.validation.questionRequired": "質問を入力してください。",
    "form.help.groupOrder": "山A/B/Cから引く順番を選びます。デフォルト: A→B→C",
    "form.help.reversed": "チェックすると逆位置で出る場合があります。",
    "picker.hint": "現在/未来/過去の山を、クリックした順に上に重ねてシャッフルします。",
    "picker.currentOrder": "現在の順番",
    "picker.default": "デフォルト",
    "picker.reverse": "逆順",
    "picker.dropHint": "ここに好みの順番でカードを重ねてください",
    "picker.reset": "リセット",
    "role.past": "過去",
    "role.present": "現在",
    "role.future": "未来",
    "group.A.role": "過去",
    "group.B.role": "現在",
    "group.C.role": "未来",
    "group.A.label": "過去",
    "group.B.label": "現在",
    "group.C.label": "未来",
    "picker.slot": "順番",
    "picker.num": "番",
    "history.title": "履歴",
    "history.clearAll": "全て削除",
    "history.delete": "削除",
    "result.title": "結果",
    "share.copy": "共有リンクをコピー",
      "share.copied": "共有リンクをコピーしました。",
    "daily.button": "今日のカード",
    "loading.meaning": "意味を読み込み中...",
    "loading.title": "全体解説を生成中",
    "loading.checkCache": "キャッシュを確認中...",
    "loading.request": "解説をリクエスト中...",
    "loading.fetch": "結果を取得中...",
    "loading.done": "完了！",
    "orientation.upright": "正位置",
    "orientation.reversed": "逆位置",
    "badge.upright": "正",
    "badge.reversed": "逆",
    "modal.cardDetail": "カード詳細",
    "no.meaning": "意味のデータがありません。",
    "view.full": "全体解説を見る",
    "spreads.title": "スプレッド選択",
    "btn.guide": "ガイド",
    "btn.use": "使う",
    "nav.question": "質問",
    "nav.summary": "要約",
    "nav.positions": "ポジション",
    "nav.sections": "セクション",
    "nav.advices": "アドバイス",
    "nav.back": "戻る",
    "label.keywords": "キーワード",
    "label.solutionCard": "ソリューションカード",
    "position.1": "課題",
    "position.2": "隠れた影響",
    "position.3": "過去",
    "position.4": "現在",
    "position.5": "近未来",
    "position.6": "内面",
    "position.7": "外部",
    "position.8": "ソリューション",
    "role.std.issue": "課題",
    "role.std.hidden": "隠れた影響",
    "role.std.past": "過去",
    "role.std.present": "現在",
    "role.std.near": "近未来",
    "role.std.inner": "内面",
    "role.std.external": "外部",
    "role.std.solution": "ソリューション",
  },
  zh: {
    "hero.heading1": "让你的",
    "hero.heading2": "解读！",
    "hero.tagline": "复古风格塔罗UI",
    "form.title": "塔罗占卜",
    "form.question": "问题",
    "form.lang": "语言",
    "form.placeholder.question": "会有怎样的人走进我的生活？",
    "form.groupOrder": "如何洗牌？",
    "form.reversed": "包含逆位",
    "form.draw8": "抽取 8 张卡",
    "form.loading": "加载中...",
    "form.validation.questionRequired": "请输入问题。",
    "form.help.groupOrder": "从 现在/未来/过去 的卡堆中按想要的顺序叠放并洗牌",
    "form.help.reversed": "勾选后可能出现逆位。",
    "picker.hint": "",
    "picker.currentOrder": "当前顺序",
    "picker.default": "默认",
    "picker.reverse": "逆序",
    "picker.dropHint": "请按想要的顺序将卡片拖到这里叠放",
    "picker.reset": "重置",
    "role.past": "过去",
    "role.present": "现在",
    "role.future": "未来",
    "group.A.role": "过去",
    "group.B.role": "现在",
    "group.C.role": "未来",
    "group.A.label": "过去",
    "group.B.label": "现在",
    "group.C.label": "未来",
    "history.title": "历史",
    "history.clearAll": "全部删除",
    "history.delete": "删除",
    "result.title": "结果",
    "share.copy": "复制分享链接",
      "share.copied": "分享链接已复制。",
    "daily.button": "今日运势",
    "loading.meaning": "加载含义...",
    "loading.title": "正在生成完整解读",
    "loading.checkCache": "检查缓存...",
    "loading.request": "请求解读...",
    "loading.fetch": "获取结果...",
    "loading.done": "完成！",
    "orientation.upright": "正位",
    "orientation.reversed": "逆位",
    "badge.upright": "正",
    "badge.reversed": "逆",
    "modal.cardDetail": "卡牌详情",
    "no.meaning": "暂无含义数据。",
    "view.full": "查看完整解读",
    "spreads.title": "牌阵选择",
    "btn.guide": "指南",
    "btn.use": "使用",
    "nav.question": "问题",
    "nav.summary": "摘要",
    "nav.positions": "位置",
    "nav.sections": "章节",
    "nav.advices": "建议",
    "nav.back": "返回",
    "label.keywords": "关键词",
    "label.solutionCard": "解决方案卡",
    "position.1": "问题",
    "position.2": "潜在影响",
    "position.3": "过去",
    "position.4": "现在",
    "position.5": "近期",
    "position.6": "内在",
    "position.7": "外部",
    "position.8": "解决方案",
    "role.std.issue": "问题",
    "role.std.hidden": "潜在影响",
    "role.std.past": "过去",
    "role.std.present": "现在",
    "role.std.near": "近期",
    "role.std.inner": "内在",
    "role.std.external": "外部",
    "role.std.solution": "解决方案",
  },
};

type I18nValue = {
  locale: Locale;
  setLocale: (l: Locale) => void;
  t: (key: string) => string;
};

const I18nCtx = createContext<I18nValue | null>(null);

export function I18nProvider({ children }: PropsWithChildren) {
  // SSR/CSR 초기 일치 보장: 최초 렌더는 항상 'ko'로 고정하여 hydration 불일치를 방지
  const [locale, setLocaleState] = useState<Locale>("ko");
  useEffect(() => {
    try {
      const saved = (localStorage.getItem("locale_v1") || "").toLowerCase();
      if (saved === "ko" || saved === "en" || saved === "ja" || saved === "zh") { setLocaleState(saved as Locale); return; }
      const nav = (navigator.language || "en").toLowerCase();
      if (nav.startsWith("ko")) { setLocaleState("ko"); return; }
      if (nav.startsWith("ja")) { setLocaleState("ja"); return; }
      if (nav.startsWith("zh")) { setLocaleState("zh"); return; }
      setLocaleState("en");
    } catch {
      // ignore
    }
  }, []);
  const setLocale = useCallback((l: Locale) => {
    setLocaleState(l);
    try { localStorage.setItem("locale_v1", l); window.dispatchEvent(new Event("locale-changed")); } catch {}
  }, []);
  const t = useCallback((key: string) => {
    const m = dict[locale][key];
    return m ?? dict.en[key] ?? key;
  }, [locale]);
  const value = useMemo<I18nValue>(()=> ({ locale, setLocale, t }), [locale, setLocale, t]);
  return <I18nCtx.Provider value={value}>{children}</I18nCtx.Provider>;
}

export function useI18n() {
  const ctx = useContext(I18nCtx);
  if (!ctx) throw new Error("useI18n must be used within I18nProvider");
  return ctx;
}


